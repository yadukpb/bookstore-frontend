{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __exportStar = this && this.__exportStar || function (m, exports) {\n  for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Agent = void 0;\nconst net = __importStar(require(\"net\"));\nconst http = __importStar(require(\"http\"));\nconst https_1 = require(\"https\");\n__exportStar(require(\"./helpers\"), exports);\nconst INTERNAL = Symbol('AgentBaseInternalState');\nclass Agent extends http.Agent {\n  constructor(opts) {\n    super(opts);\n    this[INTERNAL] = {};\n  }\n  /**\n   * Determine whether this is an `http` or `https` request.\n   */\n  isSecureEndpoint(options) {\n    if (options) {\n      // First check the `secureEndpoint` property explicitly, since this\n      // means that a parent `Agent` is \"passing through\" to this instance.\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      if (typeof options.secureEndpoint === 'boolean') {\n        return options.secureEndpoint;\n      }\n      // If no explicit `secure` endpoint, check if `protocol` property is\n      // set. This will usually be the case since using a full string URL\n      // or `URL` instance should be the most common usage.\n      if (typeof options.protocol === 'string') {\n        return options.protocol === 'https:';\n      }\n    }\n    // Finally, if no `protocol` property was set, then fall back to\n    // checking the stack trace of the current call stack, and try to\n    // detect the \"https\" module.\n    const {\n      stack\n    } = new Error();\n    if (typeof stack !== 'string') return false;\n    return stack.split('\\n').some(l => l.indexOf('(https.js:') !== -1 || l.indexOf('node:https:') !== -1);\n  }\n  // In order to support async signatures in `connect()` and Node's native\n  // connection pooling in `http.Agent`, the array of sockets for each origin\n  // has to be updated synchronously. This is so the length of the array is\n  // accurate when `addRequest()` is next called. We achieve this by creating a\n  // fake socket and adding it to `sockets[origin]` and incrementing\n  // `totalSocketCount`.\n  incrementSockets(name) {\n    // If `maxSockets` and `maxTotalSockets` are both Infinity then there is no\n    // need to create a fake socket because Node.js native connection pooling\n    // will never be invoked.\n    if (this.maxSockets === Infinity && this.maxTotalSockets === Infinity) {\n      return null;\n    }\n    // All instances of `sockets` are expected TypeScript errors. The\n    // alternative is to add it as a private property of this class but that\n    // will break TypeScript subclassing.\n    if (!this.sockets[name]) {\n      // @ts-expect-error `sockets` is readonly in `@types/node`\n      this.sockets[name] = [];\n    }\n    const fakeSocket = new net.Socket({\n      writable: false\n    });\n    this.sockets[name].push(fakeSocket);\n    // @ts-expect-error `totalSocketCount` isn't defined in `@types/node`\n    this.totalSocketCount++;\n    return fakeSocket;\n  }\n  decrementSockets(name, socket) {\n    if (!this.sockets[name] || socket === null) {\n      return;\n    }\n    const sockets = this.sockets[name];\n    const index = sockets.indexOf(socket);\n    if (index !== -1) {\n      sockets.splice(index, 1);\n      // @ts-expect-error  `totalSocketCount` isn't defined in `@types/node`\n      this.totalSocketCount--;\n      if (sockets.length === 0) {\n        // @ts-expect-error `sockets` is readonly in `@types/node`\n        delete this.sockets[name];\n      }\n    }\n  }\n  // In order to properly update the socket pool, we need to call `getName()` on\n  // the core `https.Agent` if it is a secureEndpoint.\n  getName(options) {\n    const secureEndpoint = typeof options.secureEndpoint === 'boolean' ? options.secureEndpoint : this.isSecureEndpoint(options);\n    if (secureEndpoint) {\n      // @ts-expect-error `getName()` isn't defined in `@types/node`\n      return https_1.Agent.prototype.getName.call(this, options);\n    }\n    // @ts-expect-error `getName()` isn't defined in `@types/node`\n    return super.getName(options);\n  }\n  createSocket(req, options, cb) {\n    const connectOpts = {\n      ...options,\n      secureEndpoint: this.isSecureEndpoint(options)\n    };\n    const name = this.getName(connectOpts);\n    const fakeSocket = this.incrementSockets(name);\n    Promise.resolve().then(() => this.connect(req, connectOpts)).then(socket => {\n      this.decrementSockets(name, fakeSocket);\n      if (socket instanceof http.Agent) {\n        // @ts-expect-error `addRequest()` isn't defined in `@types/node`\n        return socket.addRequest(req, connectOpts);\n      }\n      this[INTERNAL].currentSocket = socket;\n      // @ts-expect-error `createSocket()` isn't defined in `@types/node`\n      super.createSocket(req, options, cb);\n    }, err => {\n      this.decrementSockets(name, fakeSocket);\n      cb(err);\n    });\n  }\n  createConnection() {\n    const socket = this[INTERNAL].currentSocket;\n    this[INTERNAL].currentSocket = undefined;\n    if (!socket) {\n      throw new Error('No socket was returned in the `connect()` function');\n    }\n    return socket;\n  }\n  get defaultPort() {\n    return this[INTERNAL].defaultPort ?? (this.protocol === 'https:' ? 443 : 80);\n  }\n  set defaultPort(v) {\n    if (this[INTERNAL]) {\n      this[INTERNAL].defaultPort = v;\n    }\n  }\n  get protocol() {\n    return this[INTERNAL].protocol ?? (this.isSecureEndpoint() ? 'https:' : 'http:');\n  }\n  set protocol(v) {\n    if (this[INTERNAL]) {\n      this[INTERNAL].protocol = v;\n    }\n  }\n}\nexports.Agent = Agent;","map":{"version":3,"mappings":"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","names":["__exportStar","INTERNAL","Symbol","Agent","http","constructor","opts","isSecureEndpoint","options","secureEndpoint","protocol","stack","Error","split","some","l","indexOf","incrementSockets","name","maxSockets","Infinity","maxTotalSockets","sockets","fakeSocket","net","Socket","writable","push","totalSocketCount","decrementSockets","socket","index","splice","length","getName","https_1","prototype","call","createSocket","req","cb","connectOpts","Promise","resolve","then","connect","addRequest","currentSocket","err","createConnection","undefined","defaultPort","v","exports"],"sources":["../src/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script","externalDependencies":[]}